<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í˜¸ë‚¨ê³ ë“±í•™êµ AI ì˜ì‘ ì²¨ì‚­ ë„ìš°ë¯¸</title>
    <!-- Tailwind CSS CDN --><script src="https://cdn.tailwindcss.com"></script>
    <!-- Noto Sans KR í°íŠ¸ (í•œêµ­ì–´ ì„¤ëª…ì„ ìœ„í•´) --><link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* Noto Sans KR í°íŠ¸ ì ìš© */
        body {
            font-family: 'Noto Sans KR', sans-serif;
            /* (ìœ ì§€) ì „ì²´ ë°°ê²½ìƒ‰ - ì°¨ë¶„í•œ ë¯¸ìƒ‰ ê³„ì—´ */
            background-color: #f8f8f8; /* ì•„ì£¼ ì—°í•œ íšŒìƒ‰/ë¯¸ìƒ‰ */
        }
        /* ë¡œë”© ìŠ¤í”¼ë„ˆ ìŠ¤íƒ€ì¼ */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            /* (ìˆ˜ì •) ìŠ¤í”¼ë„ˆ ìƒ‰ìƒ - ê°•ì¡°ìƒ‰ê³¼ í†µì¼ */
            border-left-color: #10B981; /* Tailwind green-500 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        /* ì˜¤ë””ì˜¤ ë¡œë”©ìš© ì‘ì€ ìŠ¤í”¼ë„ˆ */
        .spinner-sm {
            border: 3px solid rgba(0, 0, 0, 0.1);
            /* (ìˆ˜ì •) ì‘ì€ ìŠ¤í”¼ë„ˆ ìƒ‰ìƒ - ê°•ì¡°ìƒ‰ê³¼ í†µì¼ */
            border-left-color: #10B981; /* Tailwind green-500 */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- (ìœ ì§€) ë©”ì¸ ì½˜í…ì¸  ë°°ê²½ìƒ‰, ê·¸ë¦¼ì --><main class="bg-white w-full max-w-4xl p-6 md:p-10 rounded-xl shadow-lg">
        
        <!-- í—¤ë” --><header class="text-center mb-8">
            <!-- (ìœ ì§€) í—¤ë” í…ìŠ¤íŠ¸ ìƒ‰ìƒ --><h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-2">í˜¸ë‚¨ê³  AI ì˜ì‘ ì²¨ì‚­ ë„ìš°ë¯¸</h1>
            <!-- (ìœ ì§€) ë³´ì¡° í…ìŠ¤íŠ¸ ìƒ‰ìƒ --><p class="text-lg text-gray-600">ì˜ì–´ ë¬¸ì¥ì„ ì…ë ¥í•´ì£¼ì„¸ìš”. AIê°€ ì²¨ì‚­í•˜ê³  ì„¤ëª…í•´ ë“œë ¤ìš”.</p>
        </header>

        <!-- (ìœ ì§€) ìš”ì²­í•˜ì‹  ì´ë¯¸ì§€ --><section class="mb-6">
            <img src="https://ivy-rugby-daf.notion.site/image/attachment%3A5a3af488-55e2-46e0-b01d-863c08ea1c08%3Aimage.png?table=block&id=2983ec20-06d9-80f9-896c-fbf6a0b7bed0&spaceId=a57f2ff5-0671-465c-bf6a-c699bdf0fd16&width=1420&userId=&cache=v2" 
                 alt="AI ì˜ì‘ ì²¨ì‚­ ê°€ì´ë“œ ì´ë¯¸ì§€" 
                 class="w-full h-auto rounded-lg shadow-md object-cover mb-6"
                 onerror="this.style.display='none'"> <!-- ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨ ì‹œ ìˆ¨ê¹€ ì²˜ë¦¬ --></section>
        
        <!-- (ì‹ ê·œ) ì¶”ê°€ëœ ì´ë¯¸ì§€ ì„¹ì…˜ --><section class="mb-6">
            <img src="https://ivy-rugby-daf.notion.site/image/attachment%3Ac64f038e-cbcb-4d9e-9f03-10cfd1a7ad59%3Aimage.png?table=block&id=2983ec20-06d9-8040-903d-e0b5c91552cc&spaceId=a57f2ff5-0671-465c-bf6a-c699bdf0fd16&width=1420&userId=&cache=v2" 
                 alt="ì„¤ëª…ì„ ìœ„í•œ ì´ë¯¸ì§€" 
                 class="w-full h-auto rounded-lg shadow-md object-cover mb-6"
                 onerror="this.style.display='none'">
        </section>

        <!-- (ì‹ ê·œ) ì°¸ê³ í•  ì˜ì‘ ì˜ˆë¬¸ í˜•ì‹ ì„¹ì…˜ -->
        <section class="mb-6">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">ì°¸ê³ í•  ì˜ì‘ ì˜ˆë¬¸ í˜•ì‹ : ë³¸ì¸ì´ ì§ì ‘ ë§Œë“¤ì–´ì„œ ì˜ì‘ê°€ëŠ¥</h3>
            <div class="space-y-4 bg-gray-50 p-6 rounded-lg border border-gray-200 shadow-inner">
                
                <!-- Point 1 -->
                <div>
                    <p class="font-semibold text-gray-700">Point 1. ì• ë¬¸ì¥ ì „ì²´ë¥¼ ë°›ëŠ” ê´€ê³„ëŒ€ëª…ì‚¬ which (ê³„ì†ì  ìš©ë²•)</p>
                    <p class="text-sm text-gray-600 mb-3">(ì½¤ë§ˆ(,)ì™€ whichë¥¼ ì‚¬ìš©í•˜ì—¬ 'ê·¸ë¦¬ê³  ê·¸ê²ƒì€ ~í–ˆë‹¤'ë¼ëŠ” ì˜ë¯¸ì˜ ë¬¸ì¥ì„ ë§Œë“¤ì–´ ë³´ì„¸ìš”.)</p>
                    <ul class="list-disc list-inside text-gray-700 space-y-2 text-sm">
                        <li>ë¹„ê°€ ëª¹ì‹œ ë‚´ë¦¬ê¸° ì‹œì‘í–ˆê³ , ê·¸ê²ƒì€ ìš°ë¦¬ê°€ ì†Œí’ì„ ì·¨ì†Œí•˜ê²Œ ë§Œë“¤ì—ˆë‹¤. (heavily, cancel)</li>
                        <li>ê·¸ëŠ” ì•ŒëŒ ë§ì¶”ëŠ” ê²ƒì„ ìŠì—ˆê³ , ê·¸ê²ƒì€ ê·¸ê°€ ë©´ì ‘ì— ëŠ¦ëŠ” ì›ì¸ì´ ë˜ì—ˆë‹¤. (set his alarm, caused)</li>
                        <li>ê·¸ë…€ëŠ” í•˜ë£»ë°¤ ë§Œì— ëª¨ë“  ìˆ™ì œë¥¼ ëëƒˆëŠ”ë°, ê·¸ê²ƒì€ ì„ ìƒë‹˜ì„ ì •ë§ ê°ëª…ì‹œì¼°ë‹¤. (in one night, impressed)</li>
                        <li>ë‚´ ì¹œêµ¬ê°€ ë‚˜ì—ê²Œ ê±°ì§“ë§ì„ í–ˆê³ , ê·¸ê²ƒì€ ë‚˜ë¥¼ ë§¤ìš° ì‹¤ë§í•˜ê²Œ ë§Œë“¤ì—ˆë‹¤. (lied to me)</li>
                        <li>ê°€ê²Œê°€ ë‹«í˜€ ìˆì—ˆê³ , ê·¸ê²ƒì€ ìš°ë¦¬ê°€ ê°„ì‹ì„ ì‚´ ìˆ˜ ì—†ë‹¤ëŠ” ê²ƒì„ ì˜ë¯¸í–ˆë‹¤. (was closed)</li>
                    </ul>
                </div>

                <!-- Point 2 -->
                <div>
                    <p class="font-semibold text-gray-700 mt-4">Point 2. ë™ì‚¬ + ëª©ì ì–´ + to ë¶€ì •ì‚¬</p>
                    <p class="text-sm text-gray-600 mb-3">('ë™ì‚¬ + ëª©ì ì–´ + to R' êµ¬ë¬¸ì„ ì‚¬ìš©í•˜ì—¬ 'ëª©ì ì–´ê°€ ~í•˜ë„ë¡ ~í•˜ë‹¤'ë¼ëŠ” ì˜ë¯¸ì˜ ë¬¸ì¥ì„ ë§Œë“¤ì–´ ë³´ì„¸ìš”.)</p>
                    <ul class="list-disc list-inside text-gray-700 space-y-2 text-sm">
                        <li>ë¶€ëª¨ë‹˜ì€ ë‚´ê°€ ì£¼ë§ì— ëŠ¦ê²Œê¹Œì§€ ê¹¨ì–´ ìˆë„ë¡ í—ˆë½í•˜ì…¨ë‹¤. (allowed, stay up late)</li>
                        <li>ì„ ìƒë‹˜ì€ í•™ìƒë“¤ì—ê²Œ ì‹œí—˜ ì „ì— í•„ê¸°ë¥¼ ë³µìŠµí•˜ë¼ê³  ì¡°ì–¸í–ˆë‹¤. (review, notes)</li>
                        <li>ìš°ë¦¬ëŠ” ê·¸ê°€ ìš°ë¦¬ íŒ€ì— í•©ë¥˜í•˜ë„ë¡ ì„¤ë“í–ˆë‹¤. (join)</li>
                        <li>ê·¸ ì–´ë ¤ìš´ ìƒí™©ì€ ê·¸ë…€ê°€ ë§ˆìŒì„ ë°”ê¾¸ë„ë¡ ì•¼ê¸°í–ˆë‹¤. (caused, change her mind)</li>
                        <li>ê·¸ íšŒì‚¬ëŠ” ëª¨ë“  ì§ì›ì´ ìœ ë‹ˆí¼ì„ ì…ë„ë¡ ìš”êµ¬í•œë‹¤. (requires, wear a uniform)</li>
                    </ul>
                </div>

            </div>
        </section>

        <!-- ì…ë ¥ ì„¹ì…˜ --><section class="mb-6">
            <!-- (ìœ ì§€) ë¼ë²¨ í…ìŠ¤íŠ¸ ìƒ‰ìƒ --><label for="userInput" class="block text-lg font-semibold text-gray-800 mb-2">ì²¨ì‚­ë°›ì„ ë¬¸ì¥ ì…ë ¥:</label>
            <!-- (ìœ ì§€) ì¸í’‹ í•„ë“œ í¬ì»¤ìŠ¤ ë§ ìƒ‰ìƒ --><textarea id="userInput"
                class="w-full h-48 p-4 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:outline-none transition-shadow resize-none"
                placeholder="ì—¬ê¸°ì— ì²¨ì‚­ë°›ê³  ì‹¶ì€ ì˜ì–´ ë¬¸ì¥ì„ ì…ë ¥í•˜ì„¸ìš”. (ì˜ˆ: I am study English very hard.)"></textarea>
        </section>

        <!-- ì œì¶œ ë²„íŠ¼ --><section class="text-center mb-8">
            <!-- (ìˆ˜ì •) ë²„íŠ¼ ìƒ‰ìƒ - ì´ë¯¸ì§€ ê°•ì¡°ìƒ‰(ë…¹ìƒ‰)ìœ¼ë¡œ ë³€ê²½ --><button id="submitButton"
                class="w-full md:w-auto bg-green-600 text-white font-bold text-lg py-3 px-10 rounded-lg shadow-md hover:bg-green-700 transition-colors duration-300 disabled:bg-gray-400">
                AI ì²¨ì‚­ ë°›ê¸°
            </button>
        </section>

        <!-- ë¡œë”© ì¸ë””ì¼€ì´í„° --><div id="loadingIndicator" class="hidden flex flex-col items-center justify-center my-10">
            <div class="spinner"></div>
            <!-- (ìœ ì§€) ë¡œë”© í…ìŠ¤íŠ¸ ìƒ‰ìƒ --><p class="text-gray-600 mt-4 text-lg">AIê°€ ì—´ì‹¬íˆ ë¬¸ì¥ì„ ë¶„ì„í•˜ê³  ìˆì–´ìš”. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</p>
        </div>

        <!-- ê²°ê³¼ ì„¹ì…˜ --><section id="resultsContainer" class="hidden space-y-8">
            
            <!-- 1. ì›ë³¸ ë¬¸ì¥ --><div>
                <!-- (ìœ ì§€) í—¤ë” í…ìŠ¤íŠ¸ ìƒ‰ìƒ --><h2 class="text-2xl font-semibold text-gray-800 mb-3">ğŸ“ ì›ë³¸ ë¬¸ì¥</h2>
                <!-- (ìˆ˜ì •) ë°°ê²½ìƒ‰, í…Œë‘ë¦¬, í…ìŠ¤íŠ¸ ìƒ‰ìƒ - ì°¨ë¶„í•œ í†¤ ìœ ì§€ --><div class="bg-gray-50 p-5 rounded-lg border border-gray-200 shadow-inner">
                    <p id="originalText" class="text-gray-700 leading-relaxed"></p>
                </div>
            </div>

            <!-- 2. AI ì²¨ì‚­ ë¬¸ì¥ (ë“£ê¸° ë²„íŠ¼ ì¶”ê°€) --><div>
                <div class="flex items-center justify-between mb-3">
                    <!-- (ìˆ˜ì •) AI ì²¨ì‚­ ë¬¸ì¥ í—¤ë” ìƒ‰ìƒ - ë…¹ìƒ‰ìœ¼ë¡œ ë³€ê²½ --><h2 class="text-2xl font-semibold text-green-700">âœ¨ AI ì²¨ì‚­ ë¬¸ì¥</h2>
                    <div class="flex items-center space-x-2">
                        <!-- ì˜¤ë””ì˜¤ ë¡œë”© ìŠ¤í”¼ë„ˆ (ì‘ì€) --><div id="audioLoadingSpinner" class="spinner-sm hidden"></div>
                        
                        <!-- (ìˆ˜ì •) ë“£ê¸° ë²„íŠ¼ ìƒ‰ìƒ - ë©”ì¸ ë²„íŠ¼ê³¼ í†µì¼ (ë…¹ìƒ‰) --><button id="speakButton"
                            class="flex items-center space-x-2 bg-green-600 text-white py-2 px-4 rounded-lg shadow hover:bg-green-700 transition-colors disabled:bg-gray-400"
                            disabled>
                            <!-- SVG ìŠ¤í”¼ì»¤ ì•„ì´ì½˜ --><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
                            </svg>
                            <span>ë“£ê¸°</span>
                        </button>
                    </div>
                </div>
                <!-- (ìˆ˜ì •) AI ì²¨ì‚­ ë¬¸ì¥ ë°°ê²½ìƒ‰ ë° í…Œë‘ë¦¬ ìƒ‰ìƒ - ë…¹ìƒ‰ ê³„ì—´ë¡œ ë³€ê²½ --><div class="bg-green-50 p-5 rounded-lg border border-green-200 shadow-inner">
                    <p id="correctedText" class="text-green-800 font-medium leading-relaxed"></p>
                </div>
            </div>

            <!-- 3. ì²¨ì‚­ ì„¤ëª… --><div>
                <!-- (ìˆ˜ì •) ì²¨ì‚­ ì„¤ëª… í—¤ë” ìƒ‰ìƒ - ì£¼í™©ìƒ‰ìœ¼ë¡œ ë³€ê²½ --><h2 class="text-2xl font-semibold text-orange-700 mb-3">ğŸ’¡ ì²¨ì‚­ ì„¤ëª… (í•œêµ­ì–´)</h2>
                <!-- (ìˆ˜ì •) ì²¨ì‚­ ì„¤ëª… ë°°ê²½ìƒ‰ ë° í…Œë‘ë¦¬ ìƒ‰ìƒ - ì£¼í™©ìƒ‰ ê³„ì—´ë¡œ ë³€ê²½ --><div class="bg-orange-50 p-5 rounded-lg border border-orange-200 shadow-inner">
                    <!-- whitespace-pre-wrap: AIê°€ ìƒì„±í•œ ì¤„ë°”ê¿ˆ(ë²ˆí˜¸ ëª©ë¡)ì„ ê·¸ëŒ€ë¡œ í‘œì‹œ --><div id="explanationText" class="text-orange-800 leading-relaxed whitespace-pre-wrap"></div>
                </div>
            </div>

        </section>

        <!-- ì—ëŸ¬ ë©”ì‹œì§€ --><div id="errorMessage" class="hidden text-center text-red-600 font-semibold mt-6 p-4 bg-red-100 rounded-lg">
        </div>

        <!-- ì˜¤ë””ì˜¤ ì¬ìƒì„ ìœ„í•œ ìˆ¨ê²¨ì§„ ìš”ì†Œ --><audio id="audioPlayer" class="hidden"></audio>

        <!-- (ì¶”ê°€) í‘¸í„° ì„¹ì…˜ --><footer class="mt-12 pt-6 border-t border-gray-200">
            <p class="text-xs text-gray-500 text-center leading-relaxed">
                Copyrightâ“’ í˜¸ë‚¨ê³ ë“±í•™êµ. All rights reserved<br>
                ì£¼ì†Œ : (ìš°:56202) ì „ë¶íŠ¹ë³„ìì¹˜ë„ ì •ìì‹œ ì •ìë‚¨ë¡œ 1364-13<br>
                ì „í™” : êµë¬´ì‹¤:063-570-7815&nbsp; í–‰ì •ì‹¤ : 570-7884~1&nbsp; FAX : 537-7182
            </p>
        </footer>

    </main>

    <script>
        // DOM ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
        const userInput = document.getElementById('userInput');
        const submitButton = document.getElementById('submitButton');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const resultsContainer = document.getElementById('resultsContainer');
        const originalText = document.getElementById('originalText');
        const correctedText = document.getElementById('correctedText');
        const explanationText = document.getElementById('explanationText');
        const errorMessage = document.getElementById('errorMessage');
        
        // --- (ì¶”ê°€) TTS ê´€ë ¨ DOM ìš”ì†Œ ---
        const speakButton = document.getElementById('speakButton');
        const audioPlayer = document.getElementById('audioPlayer');
        const audioLoadingSpinner = document.getElementById('audioLoadingSpinner');
        let currentAudioUrl = null; // í˜„ì¬ ì˜¤ë””ì˜¤ URL ì €ì¥
        // --------------------------------

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        submitButton.addEventListener('click', handleSubmit);
        speakButton.addEventListener('click', handleSpeak); // (ì¶”ê°€) ë“£ê¸° ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸

        /**
         * í¼ ì œì¶œ ë° AI í˜¸ì¶œì„ ì²˜ë¦¬í•˜ëŠ” ë©”ì¸ í•¨ìˆ˜
         */
        async function handleSubmit() {
            const userText = userInput.value.trim();

            if (!userText) {
                showError("ì²¨ì‚­ë°›ì„ ë¬¸ì¥ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }
            
            showLoading(true);
            showError(null); 

            try {
                const result = await callGeminiAPI(userText);
                displayResults(userText, result.corrected_sentence, result.explanation_korean);
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                showError("ì²¨ì‚­ì„ ì§„í–‰í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
            } finally {
                showLoading(false);
            }
        }

        /**
         * Gemini APIë¥¼ í˜¸ì¶œí•˜ì—¬ ì²¨ì‚­ ê²°ê³¼(JSON)ë¥¼ ë°›ì•„ì˜¤ëŠ” í•¨ìˆ˜
         * @param {string} text - ì‚¬ìš©ìê°€ ì…ë ¥í•œ ì›ë³¸ ì˜ì–´ ë¬¸ì¥
         * @returns {Promise<object>} - { corrected_sentence, explanation_korean }
         */
        async function callGeminiAPI(text) {
            const apiKey = "AIzaSyAvzAJ1YR-nlgTIinhHapo18lJM5X5oPx8"; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            // (ìˆ˜ì •) AI ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸: ì„¤ëª… ë¶€ë¶„ì„ ë²ˆí˜¸ ëª©ë¡ìœ¼ë¡œ ìš”ì²­
            const systemPrompt = `
                ë‹¹ì‹ ì€ í•œêµ­ ê³ ë“±í•™êµ 1í•™ë…„ í•™ìƒë“¤ì„ ìœ„í•œ ì „ë¬¸ AI ì˜ì–´ êµì‚¬ì…ë‹ˆë‹¤.
                í•™ìƒì´ ì…ë ¥í•œ ì˜ì–´ ë¬¸ì¥ì„ ë¬¸ë²•ê³¼ ë¬¸ë§¥ì— ë§ê²Œ ìì—°ìŠ¤ëŸ½ê²Œ ì²¨ì‚­í•´ì•¼ í•©ë‹ˆë‹¤.
                
                ë‹¤ìŒ ë‘ ê°€ì§€ë¥¼ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•´ì•¼ í•©ë‹ˆë‹¤.
                1. "corrected_sentence": ë‹¹ì‹ ì´ ìˆ˜ì •í•œ ì™„ì „í•œ ì˜ì–´ ë¬¸ì¥.
                2. "explanation_korean": ì™œ ê·¸ë ‡ê²Œ ìˆ˜ì •í–ˆëŠ”ì§€, ì›ë³¸ ë¬¸ì¥ì˜ ì–´ë–¤ ë¶€ë¶„ì´ ë¬¸ë²•ì ìœ¼ë¡œ í‹€ë ¸ëŠ”ì§€, ë˜ëŠ” ì–´íœ˜ ì„ íƒì´ ì–´ìƒ‰í–ˆëŠ”ì§€ ë“±ì„ ì›ë³¸ê³¼ ë¹„êµí•˜ë©° ê³ ë“±í•™ìƒì´ ì´í•´í•˜ê¸° ì‰½ê²Œ í•œêµ­ì–´ë¡œ ì¹œì ˆí•˜ê²Œ ì„¤ëª…í•˜ëŠ” ê¸€. 
                   **ì„¤ëª…ì€ 1., 2., 3. ê³¼ ê°™ì€ ë²ˆí˜¸ ëª©ë¡ í˜•ì‹ìœ¼ë¡œ, ê° í•­ëª©ì€ ì¤„ë°”ê¿ˆ(\\n)ìœ¼ë¡œ êµ¬ë¶„í•˜ì—¬ ëª…í™•í•˜ê²Œ ì œê³µí•´ ì£¼ì„¸ìš”.**
            `;

            const payload = {
                contents: [{
                    parts: [{ text: text }]
                }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "corrected_sentence": {
                                "type": "STRING",
                                "description": "ì²¨ì‚­ì´ ì™„ë£Œëœ ìì—°ìŠ¤ëŸ¬ìš´ ì˜ì–´ ë¬¸ì¥"
                            },
                            "explanation_korean": {
                                "type": "STRING",
                                "description": "1., 2., 3. í˜•ì‹ì˜ ë²ˆí˜¸ ëª©ë¡ìœ¼ë¡œ ì‘ì„±ëœ í•œêµ­ì–´ ì„¤ëª…"
                            }
                        },
                        required: ["corrected_sentence", "explanation_korean"]
                    }
                }
            };

            const response = await fetchWithRetry(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`API Error: ${response.status} ${JSON.stringify(errorData)}`);
            }

            const result = await response.json();
            
            if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0].text) {
                const jsonString = result.candidates[0].content.parts[0].text;
                return JSON.parse(jsonString); 
            } else {
                throw new Error("Invalid API response structure");
            }
        }
        
        // --- (ì‹ ê·œ) TTS ê´€ë ¨ í•¨ìˆ˜ë“¤ ---

        /**
         * 'ë“£ê¸°' ë²„íŠ¼ í´ë¦­ ì‹œ TTS APIë¥¼ í˜¸ì¶œí•˜ê³  ì˜¤ë””ì˜¤ë¥¼ ì¬ìƒí•©ë‹ˆë‹¤.
         */
        async function handleSpeak() {
            const textToSpeak = correctedText.textContent;
            if (!textToSpeak) return;

            showAudioLoading(true);
            showError(null);

            try {
                // TTS API í˜¸ì¶œ
                const audioData = await callTTSAPI(textToSpeak);
                
                // PCM ë°ì´í„°ë¥¼ WAV Blob URLë¡œ ë³€í™˜
                const pcmData = base64ToArrayBuffer(audioData.audioData);
                const pcm16 = new Int16Array(pcmData);
                const sampleRate = parseInt(audioData.mimeType.match(/rate=(\d+)/)[1], 10) || 24000;
                
                // ì´ì „ì— ìƒì„±ëœ URLì´ ìˆë‹¤ë©´ í•´ì œ (ë©”ëª¨ë¦¬ ê´€ë¦¬)
                if (currentAudioUrl) {
                    URL.revokeObjectURL(currentAudioUrl);
                }

                const wavBlob = pcmToWav(pcm16, sampleRate);
                currentAudioUrl = URL.createObjectURL(wavBlob);
                
                // ì˜¤ë””ì˜¤ ì¬ìƒ
                audioPlayer.src = currentAudioUrl;
                audioPlayer.play();

            } catch (error) {
                console.error("Error generating or playing speech:", error);
                showError("ìŒì„±ì„ ìƒì„±í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            } finally {
                showAudioLoading(false);
            }
        }

        /**
         * Gemini TTS APIë¥¼ í˜¸ì¶œí•˜ì—¬ ì˜¤ë””ì˜¤ ë°ì´í„°ë¥¼ ë°›ì•„ì˜µë‹ˆë‹¤.
         * @param {string} text - ìŒì„±ìœ¼ë¡œ ë³€í™˜í•  í…ìŠ¤íŠ¸
         * @returns {Promise<object>} - { audioData, mimeType }
         */
        async function callTTSAPI(text) {
            const apiKey = "AIzaSyAt8ccdYqjltRxaTH6cmxA1eQsWsf6PhKs"; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{
                    parts: [{ text: `Speak this sentence clearly: ${text}` }]
                }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            // ë¯¸êµ­ì‹ ì˜ì–´ ë°œìŒ (Puck)
                            prebuiltVoiceConfig: { voiceName: "Puck" } 
                        }
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };

            const response = await fetchWithRetry(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`TTS API Error: ${response.status} ${JSON.stringify(errorData)}`);
            }

            const result = await response.json();
            const part = result?.candidates?.[0]?.content?.parts?.[0];
            const audioData = part?.inlineData?.data;
            const mimeType = part?.inlineData?.mimeType;

            if (audioData && mimeType && mimeType.startsWith("audio/")) {
                return { audioData, mimeType };
            } else {
                throw new Error("Invalid TTS API response structure");
            }
        }

        /**
         * Base64 ë¬¸ìì—´ì„ ArrayBufferë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
         */
        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        /**
         * PCM ë°ì´í„°ë¥¼ WAV Blobìœ¼ë¡œ ë³€í™˜í•©ë‹ˆë‹¤. (WAV í—¤ë” ì¶”ê°€)
         */
        function pcmToWav(pcmData, sampleRate) {
            const numChannels = 1;
            const bitsPerSample = 16;
            const dataSize = pcmData.length * (bitsPerSample / 8);
            const blockAlign = numChannels * (bitsPerSample / 8);
            const byteRate = sampleRate * blockAlign;

            const buffer = new ArrayBuffer(44 + dataSize);
            const view = new DataView(buffer);

            // RIFF chunk
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + dataSize, true);
            writeString(view, 8, 'WAVE');
            // 'fmt ' chunk
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true); // Sub-chunk 1 size
            view.setUint16(20, 1, true); // Audio format (1 = PCM)
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, byteRate, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, bitsPerSample, true);
            // 'data' chunk
            writeString(view, 36, 'data');
            view.setUint32(40, dataSize, true);

            // Write PCM data
            let offset = 44;
            for (let i = 0; i < pcmData.length; i++, offset += 2) {
                view.setInt16(offset, pcmData[i], true);
            }

            return new Blob([view], { type: 'audio/wav' });
        }

        /**
         * DataViewì— ë¬¸ìì—´ì„ ì“°ëŠ” í—¬í¼ í•¨ìˆ˜
         */
        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        // ------------------------------------

        /**
         * ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ì‹œ ì§€ìˆ˜ ë°±ì˜¤í”„ë¥¼ ì‚¬ìš©í•˜ì—¬ API í˜¸ì¶œì„ ì¬ì‹œë„í•˜ëŠ” fetch ë˜í¼ í•¨ìˆ˜
         */
        async function fetchWithRetry(url, options, retries = 3, delay = 1000) {
            try {
                const response = await fetch(url, options);
                if (!response.ok && response.status >= 500 && retries > 0) { 
                    await new Promise(res => setTimeout(res, delay));
                    return fetchWithRetry(url, options, retries - 1, delay * 2);
                }
                return response;
            } catch (error) {
                if (retries > 0) {
                    await new Promise(res => setTimeout(res, delay));
                    return fetchWithRetry(url, options, retries - 1, delay * 2);
                }
                throw error;
            }
        }

        /**
         * ë¡œë”© ìƒíƒœì— ë”°ë¼ UIë¥¼ ë³€ê²½í•˜ëŠ” í•¨ìˆ˜
         * @param {boolean} isLoading - ë¡œë”© ì¤‘ì¸ì§€ ì—¬ë¶€
         */
        function showLoading(isLoading) {
            if (isLoading) {
                submitButton.disabled = true;
                submitButton.textContent = "AIê°€ ì²¨ì‚­ ì¤‘...";
                loadingIndicator.classList.remove('hidden');
                resultsContainer.classList.add('hidden');
                speakButton.disabled = true; // (ì¶”ê°€) ë©”ì¸ ë¡œë”© ì¤‘ì—ëŠ” ë“£ê¸° ë²„íŠ¼ ë¹„í™œì„±í™”
                
                // (ì¶”ê°€) ì´ì „ ì˜¤ë””ì˜¤ URL í•´ì œ
                if (currentAudioUrl) {
                    URL.revokeObjectURL(currentAudioUrl);
                    currentAudioUrl = null;
                    audioPlayer.src = "";
                }

            } else {
                submitButton.disabled = false;
                submitButton.textContent = "AI ì²¨ì‚­ ë°›ê¸°";
                loadingIndicator.classList.add('hidden');
            }
        }
        
        /**
         * (ì‹ ê·œ) ì˜¤ë””ì˜¤ ë¡œë”© ìŠ¤í”¼ë„ˆë¥¼ ì œì–´í•˜ëŠ” í•¨ìˆ˜
         * @param {boolean} isLoading - ì˜¤ë””ì˜¤ ë¡œë”© ì¤‘ì¸ì§€ ì—¬ë¶€
         */
        function showAudioLoading(isLoading) {
             if (isLoading) {
                audioLoadingSpinner.classList.remove('hidden');
                speakButton.disabled = true;
             } else {
                audioLoadingSpinner.classList.add('hidden');
                speakButton.disabled = false;
             }
        }

        /**
         * API ê²°ê³¼ë¥¼ í™”ë©´ì— í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
         */
        function displayResults(original, corrected, explanation) {
            originalText.textContent = original;
            correctedText.textContent = corrected;
            explanationText.textContent = explanation; // pre-wrap ìŠ¤íƒ€ì¼ì´ ë²ˆí˜¸ ëª©ë¡ì˜ \nì„ ì²˜ë¦¬
            resultsContainer.classList.remove('hidden');
            speakButton.disabled = false; // (ì¶”ê°€) ê²°ê³¼ê°€ ë‚˜ì˜¤ë©´ ë“£ê¸° ë²„íŠ¼ í™œì„±í™”
        }

        /**
         * ì‚¬ìš©ìì—ê²Œ ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
         */
        function showError(message) {
            if (message) {
                errorMessage.textContent = message;
                errorMessage.classList.remove('hidden');
            } else {
                errorMessage.classList.add('hidden');
            }
        }

    </script>
</body>
</html>




